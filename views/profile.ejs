<%- include('./partials/header.ejs'); %>

<div class="container">
  <div style="margin: 2rem 0;">
    <h1>User Profile</h1>
    <p style="color: #6b7280; margin-bottom: 2rem;">Manage and update your profile information</p>
  </div>

  <div class="card">
    <div class="card-header">Personal Information</div>
    
    <form id="profileForm" method="POST" action="/dashboard/update">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        <div class="form-group">
          <label for="firstname">First Name</label>
          <input 
            type="text" 
            id="firstname" 
            value="<%= user.firstname %>" 
            disabled
          >
          <small style="color: #6b7280; margin-top: 0.25rem; display: block;">
            Cannot be changed
          </small>
        </div>

        <div class="form-group">
          <label for="lastname">Last Name</label>
          <input 
            type="text" 
            id="lastname" 
            value="<%= user.lastname %>" 
            disabled
          >
          <small style="color: #6b7280; margin-top: 0.25rem; display: block;">
            Cannot be changed
          </small>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input 
            type="email" 
            id="email" 
            value="<%= user.email %>" 
            disabled
          >
          <small style="color: #6b7280; margin-top: 0.25rem; display: block;">
            Cannot be changed
          </small>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="card-header">Academic Information</div>
    
    <form id="academicForm" method="POST" action="/dashboard/update">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        <div class="form-group">
          <label for="enrollmentNo">Enrollment Number</label>
          <input 
            type="text" 
            id="enrollmentNo" 
            name="enrollmentNo" 
            value="<%= user.enrollmentNo || '' %>" 
            placeholder="e.g., EN2024001"
            required
          >
        </div>

        <div class="form-group">
          <label for="department">Department</label>
          <select id="department" name="department" required>
            <option value="">Select Department</option>
            <option value="Computer Science" <%= user.department === 'Computer Science' ? 'selected' : '' %>>
              Computer Science
            </option>
            <option value="Information Technology" <%= user.department === 'Information Technology' ? 'selected' : '' %>>
              Information Technology
            </option>
            <option value="Electronics" <%= user.department === 'Electronics' ? 'selected' : '' %>>
              Electronics
            </option>
            <option value="Civil Engineering" <%= user.department === 'Civil Engineering' ? 'selected' : '' %>>
              Civil Engineering
            </option>
            <option value="Mechanical Engineering" <%= user.department === 'Mechanical Engineering' ? 'selected' : '' %>>
              Mechanical Engineering
            </option>
            <option value="Other" <%= user.department === 'Other' ? 'selected' : '' %>>
              Other
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="semester">Current Semester</label>
          <select id="semester" name="semester" required>
            <option value="">Select Semester</option>
            <% for (let i = 1; i <= 8; i++) { %>
              <option value="<%= i %>" <%= user.semester == i ? 'selected' : '' %>>
                Semester <%= i %>
              </option>
            <% } %>
          </select>
        </div>

        <div class="form-group">
          <label for="cgpa">CGPA</label>
          <input 
            type="number" 
            id="cgpa" 
            name="cgpa" 
            value="<%= user.cgpa || '' %>" 
            placeholder="e.g., 8.5"
            min="0"
            max="10"
            step="0.1"
          >
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Update Profile</button>
    </form>
  </div>

  <div class="card">
    <div class="card-header">Account Security</div>
    <p style="margin-bottom: 1.5rem;">
      For security reasons, please note that you cannot change your email or name directly from this portal. 
      If you need to update these details, please contact the administration.
    </p>
    <p>
      Your account was created on <strong><%= new Date(user.createdAt).toLocaleDateString() %></strong>
    </p>
  </div>
</div>

<script>
  document.getElementById('academicForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(document.getElementById('academicForm'));
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('/dashboard/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        alert('✅ ' + result.message);
        location.reload();
      } else {
        alert('❌ ' + result.message);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while updating your profile');
    }
  });
</script>

<%- include('./partials/footer.ejs'); %>
